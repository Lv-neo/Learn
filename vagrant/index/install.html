<hr>
<p>title: 使用vagrant构建开发测试环境<br>date: 2018-12-17 19:15:26<br>categories: vagrant</p>
<h2 id="tags-vagrant"><a href="#tags-vagrant" class="headerlink" title="tags: vagrant"></a>tags: vagrant</h2><h1 id="使用vagrant构建开发测试环境"><a href="#使用vagrant构建开发测试环境" class="headerlink" title="使用vagrant构建开发测试环境"></a>使用vagrant构建开发测试环境</h1><h2 id="安装virtualBox和vagrant"><a href="#安装virtualBox和vagrant" class="headerlink" title="安装virtualBox和vagrant"></a>安装virtualBox和vagrant</h2><p><a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox官方下载</a><br><a href="https://www.vagrantup.com/downloads.html">Vargant官方下载</a></p>
<h2 id="下载一个box"><a href="#下载一个box" class="headerlink" title="下载一个box"></a>下载一个box</h2><p>笔者选择的centos7.2<br><a href="https://www.vagrantup.com/docs/boxes.html">vagrantup</a><br><a href="http://www.vagrantbox.es/">vagrantbox</a></p>
<blockquote>
<p>速度太慢，请用离线下载或者下载工具，国内也有镜像资源</p>
</blockquote>
<h2 id="添加box，初始化vagrant-box"><a href="#添加box，初始化vagrant-box" class="headerlink" title="添加box，初始化vagrant box"></a>添加box，初始化vagrant box</h2><p>选择一个目录,开始构建</p>
<pre><code>$ cd ~/project/

$ vagrant box add /Users/Neo/Downloads/macTools/vagrant-centos-7.2.box --name centos7.2
==&gt; box: Box file was not detected as metadata. Adding it directly...
==&gt; box: Adding box &apos;centos7.2&apos; (v0) for provider: 
    box: Unpacking necessary files from: file:///Users/Neo/Downloads/macTools/vagrant-centos-7.2.box
==&gt; box: Successfully added box &apos;centos7.2&apos; (v0) for &apos;virtualbox&apos;!

$ vagrant box list
centos7.2 (virtualbox, 0)

$ vagrant init centos7.2
A `Vagrantfile` has been placed in this directory. You are now
ready to `vagrant up` your first virtual environment! Please read
the comments in the Vagrantfile as well as documentation on
`vagrantup.com` for more information on using Vagrant.


</code></pre><p>这样目录中就会多出一个文件叫 Vagrantfile 所有的机关也就都在这里了，比如这里面有一句 config.vm.box = “centos7.2”这样</p>
<blockquote>
<p>我不用线上的原因是太慢，如果是团队开发，一个人构建好之后丢到服务器上最合适</p>
</blockquote>
<h2 id="执行vagrant-up"><a href="#执行vagrant-up" class="headerlink" title="执行vagrant up"></a>执行vagrant up</h2><pre><code>$ vagrant up
Bringing machine &apos;default&apos; up with &apos;virtualbox&apos; provider...
==&gt; default: Importing base box &apos;centos7.2&apos;...
==&gt; default: Matching MAC address for NAT networking...
==&gt; default: Setting the name of the VM: project_default_1494056264311_10321
==&gt; default: Clearing any previously set network interfaces...
==&gt; default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
==&gt; default: Forwarding ports...
    default: 22 =&gt; 2222 (adapter 1)
==&gt; default: Booting VM...
==&gt; default: Waiting for machine to boot. This may take a few minutes...
    default: SSH address: 127.0.0.1:2222
    default: SSH username: vagrant
    default: SSH auth method: private key
    default: Warning: Connection timeout. Retrying...
    default: Warning: Remote connection disconnect. Retrying...
    default: 
    default: Vagrant insecure key detected. Vagrant will automatically replace
    default: this with a newly generated keypair for better security.
    default: 
    default: Inserting generated public key within guest...
    default: Removing insecure key from the guest if it&apos;s present...
    default: Key inserted! Disconnecting and reconnecting using new SSH key...
==&gt; default: Machine booted and ready!
==&gt; default: Checking for guest additions in VM...
    default: The guest additions on this VM do not match the installed version of
    default: VirtualBox! In most cases this is fine, but in rare cases it can
    default: prevent things such as shared folders from working properly. If you see
    default: shared folder errors, please make sure the guest additions within the
    default: virtual machine match the version of VirtualBox you have installed on
    default: your host and reload your VM.
    default: 
    default: Guest Additions Version: 4.3.30
    default: VirtualBox Version: 5.0
==&gt; default: Mounting shared folders...
    default: /vagrant =&gt; /Users/Neo/project
</code></pre><blockquote>
<p>如果你是用的网上的box，可能需要十几分钟以上，建议是放到内网或者本地</p>
</blockquote>
<h2 id="访问虚拟机"><a href="#访问虚拟机" class="headerlink" title="访问虚拟机"></a>访问虚拟机</h2><pre><code>$  vagrant ssh
[vagrant@localhost ~]$ uname -r
3.10.0-327.4.5.el7.x86_64
</code></pre><p>我们已经进入虚拟机了，登陆进来的用户名是 vagrant，这个用户挺好，执行 sudo 是不需要输入密码的，开发中实际使用挺好用的。不过如果我非要创建自己的用户也是可以的。</p>
<h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><p>关键步骤来了，vagrant默认配置不满足我们的需求</p>
<h3 id="修改内存"><a href="#修改内存" class="headerlink" title="修改内存"></a>修改内存</h3><p>默认内存512m</p>
<pre><code>v.memory = 1024
</code></pre><blockquote>
<p>你也可以进入VirtualBox修改，不过VagrantFile都可以搞定</p>
</blockquote>
<h3 id="修改网络"><a href="#修改网络" class="headerlink" title="修改网络"></a>修改网络</h3><p>网络模式有3种</p>
<ul>
<li>forwarded_port</li>
<li>private_network</li>
<li>public_network</li>
</ul>
<p>很简单，按照你的需求设置，个人开发环境建议设置为private_network</p>
<pre><code>config.vm.network &quot;private_network&quot;, ip: &quot;192.168.222.111&quot;
</code></pre><blockquote>
<p>协同开发，大家可以下载使用同一个VagrantFile，大部分配置相同，是不是很爽</p>
</blockquote>
<h3 id="修改共享目录"><a href="#修改共享目录" class="headerlink" title="修改共享目录"></a>修改共享目录</h3><p>我们需要制定共享目录的用户和权限，开发的代码就在共享目录里了。</p>
<p>在这之前必须进入vagrant增加你需要的用户www，如果你直接用vagrant，就不需要</p>
<pre><code>config.vm.synced_folder &quot;/Users/Neo/project&quot;, &quot;/vagrant&quot;,create:true, :owner =&gt; &quot;www&quot;, :group =&gt; &quot;www&quot;, :mount_options =&gt; [&quot;dmode=775&quot;,&quot;fmode=664&quot;]
</code></pre><h3 id="修改登录"><a href="#修改登录" class="headerlink" title="修改登录"></a>修改登录</h3><p>我比较喜欢crt或者xshell统一管理机器,在结尾加上</p>
<pre><code>config.ssh.username = &apos;vagrant&apos;
config.ssh.password = &apos;vagrant&apos;
config.ssh.insert_key = &apos;true&apos;
</code></pre><h3 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h3><pre><code>vagrant reload
</code></pre><h3 id="ssh免密登录"><a href="#ssh免密登录" class="headerlink" title="ssh免密登录"></a>ssh免密登录</h3><pre><code># 现在我们进入vagrant 账号root密码vagrant

[root@localhost ~]# cd ~/
[root@localhost ~]# mkdir .ssh
# 纯净的没vim，加上自己的sshkey
[root@localhost ~]# vi authorized_keys
# 保存退出
</code></pre><p>在通过crt Publickey方式，完美无密码进入</p>
<h2 id="打包box"><a href="#打包box" class="headerlink" title="打包box"></a>打包box</h2><p>装完你（团队）需要的环境之后，退出vagrant，我们打包成一个开发环境的box供大家使用</p>
<pre><code>vagrant package --output xxxx.box --vagrantfile file
</code></pre><h2 id="获取远程仓库"><a href="#获取远程仓库" class="headerlink" title="获取远程仓库"></a>获取远程仓库</h2><pre><code>vagrant box add centos7.2 http://127.0.0.1/xxxx.box
</code></pre><h2 id="附录：完整的vagrantFile"><a href="#附录：完整的vagrantFile" class="headerlink" title="附录：完整的vagrantFile"></a>附录：完整的vagrantFile</h2><pre><code># -*- mode: ruby -*-
# vi: set ft=ruby :

# All Vagrant configuration is done below. The &quot;2&quot; in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don&apos;t change it unless you know what
# you&apos;re doing.
Vagrant.configure(2) do |config|
  # The most common configuration options are documented and commented below.
  # For a complete reference, please see the online documentation at
  # https://docs.vagrantup.com.

  # Every Vagrant development environment requires a box. You can search for
  # boxes at https://atlas.hashicorp.com/search.
  config.vm.box = &quot;centos7.2&quot;

  # Disable automatic box update checking. If you disable this, then
  # boxes will only be checked for updates when the user runs
  # `vagrant box outdated`. This is not recommended.
  # config.vm.box_check_update = false

  # Create a forwarded port mapping which allows access to a specific port
  # within the machine from a port on the host machine. In the example below,
  # accessing &quot;localhost:8080&quot; will access port 80 on the guest machine.
  # config.vm.network &quot;forwarded_port&quot;, guest: 80, host: 8080

  # Create a private network, which allows host-only access to the machine
  # using a specific IP.
  config.vm.network &quot;private_network&quot;, ip: &quot;192.168.222.111&quot;

  # Create a public network, which generally matched to bridged network.
  # Bridged networks make the machine appear as another physical device on
  # your network.
  # config.vm.network &quot;public_network&quot;

  # Share an additional folder to the guest VM. The first argument is
  # the path on the host to the actual folder. The second argument is
  # the path on the guest to mount the folder. And the optional third
  # argument is a set of non-required options.
  config.vm.synced_folder &quot;/Users/Neo/project&quot;, &quot;/vagrant&quot;,create:true, :owner =&gt; &quot;www-data&quot;, :group =&gt; &quot;www-data&quot;, :mount_options =&gt; [&quot;dmode=775&quot;,&quot;fmode=664&quot;]

  # Provider-specific configuration so you can fine-tune various
  # backing providers for Vagrant. These expose provider-specific options.
  # Example for VirtualBox:
  #
  # config.vm.provider &quot;virtualbox&quot; do |vb|
  #   # Display the VirtualBox GUI when booting the machine
  #   vb.gui = true
  #
  #   # Customize the amount of memory on the VM:
  #   vb.memory = &quot;1024&quot;
  # end
  #
  # View the documentation for the provider you are using for more
  # information on available options.

  # Define a Vagrant Push strategy for pushing to Atlas. Other push strategies
  # such as FTP and Heroku are also available. See the documentation at
  # https://docs.vagrantup.com/v2/push/atlas.html for more information.
  # config.push.define &quot;atlas&quot; do |push|
  #   push.app = &quot;YOUR_ATLAS_USERNAME/YOUR_APPLICATION_NAME&quot;
  # end

  # Enable provisioning with a shell script. Additional provisioners such as
  # Puppet, Chef, Ansible, Salt, and Docker are also available. Please see the
  # documentation for more information about their specific syntax and use.
  # config.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
  #   sudo apt-get update
  #   sudo apt-get install -y apache2
  # SHELL
  config.ssh.username = &apos;vagrant&apos;
  config.ssh.password = &apos;vagrant&apos;
  config.ssh.insert_key = &apos;true&apos;
end

</code></pre>